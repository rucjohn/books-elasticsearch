# 可伸缩性和弹性：集群、节点和分片

Elasticsearch 始终可根据您的需求进行扩展，它是通过自然分布来实现的。可以将服务器（节点）添加到集群中以增加容量，Elasticsearch 会自动将数据和查询负载分布到所有可用的节点上。不需要更新应用程序，Elasticsearch 知道如何平衡多节点集群以提供规模和高可用性。节点越多越好。

那它是怎么工作的呢？实际上，Elasticsearch 索引只是一个或多个的物理分片的逻辑分组，每个分片实际上是一个独立的索引。通过将索引中的文档分布在多个分片上，并将这些分片分布在多个节点上，Elasticsearch 可以确保冗余，这既可以防止硬件故障，又可以在节点添加到集群时提高查询能力。当集群增长（收缩）时，Elasticsearch 会自动迁移分片以重新平衡集群。

分片有两种类型：主分片和副本分片。索引中的每个文档都有一个主分片。副本分片是主分片的拷贝。副本提供数据的冗余，以防止硬件故障，并提高处理读取请求（例如搜索或检索文档）的能力。

创建索引时，索引中的主分片数量被固定，但是副本分片的数量是可以随时更改的，并且不中断索引或查询操作。

## 这取决于...

在分片大小和为索引配置的主分片的数量方面，存在许多性能方面的考虑和权衡取舍。分片越多，维护这些索引的开锁越大。分片大小越大，当 Elasticsearch 需要重新平衡集群时，移动分片所需的时间就越长。

查询大量的小分片会使每个分片的处理速度更快，但更多的查询意味着更多的开锁，因此查询数量少容量大的分片可能会更快。简而言之...要看情况。

例如：
- 目标是平均分片大小保持在 1G <= X <= 100G，对于基于时间的数据用例，通常在 20G <= X <= 40G。
- 避免巨大的分片问题。节点可以保存的分片数与可用内存成正比。一般情况下，1G内存的分片数应小于20.

确定最佳配置的最好方法是 [使用自己的数据和查询进行测试](https://www.elastic.co/cn/elasticon/conf/2016/sf/quantitative-cluster-sizing)

## 万一挂了...

出于性能原因，集群中的节点都应在同一网络。跨数据中心的节点在均衡集群中的分片时需要花费很长时间。但是高可用性体系结构又要求您避免将所有的鸡蛋放在一个篮子里。当一个区域发生重大故障时，另一区域的服务器需要能够接管。答案就是跨集群复制（`CCR`）。

CCR 提供了一种将索引从主集群自动同步到可用的备份辅助远程集群的方法。如果主集群出现故障，则备用集群可以接管。您还可以使用 CCR 来创建辅助集群，以服务于地理位置相邻的用户的读取请求。

跨集群复制是`active-passive`。主集群上的索引是 active leader 索引，用于处理所有写请求。复制到辅助集群的索引是只读的。

## 运维

与任何企业系统一样，您需要工具来保护、管理和监控 Elasticsearch 集群。您能够将 Kinaba 当作管理集群的控制中心，集成了 Elasticsearch 中的安全、监控和管理功能。数据汇总和索引生命周期管理等功能可帮助您随着时间的推移智能地管理数据。